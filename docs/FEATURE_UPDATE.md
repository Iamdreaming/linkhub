# 功能更新说明

## 更新日期
2024-11-17

## 更新内容

### 1. 修复统计数据显示问题 ✅

**问题描述：**
- 统计分析页面和仪表板页面的访问数据始终显示为0
- 根本原因：前端期望的字段名与后端返回的字段名不一致

**修复内容：**
- 修复了 `frontend/src/views/stats/index.vue` 中的数据字段映射
- 修复了 `frontend/src/views/dashboard/index.vue` 中的数据字段映射
- 正确映射后端返回的字段：
  - `totalAccess` → `totalViews`
  - `todayAccess` → `todayViews`
  - `periodAccess` → `uniqueVisitors`
  - `avgDailyAccess` → `avgDailyViews`

**测试步骤：**
1. 访问短链（通过 `/r/{shortCode}` 路径）
2. 进入"统计分析"页面，选择已访问的链接
3. 查看统计数据是否正确显示访问量
4. 进入"仪表板"页面，查看总体统计数据

---

### 2. 新增密码修改功能（个人中心） ✅

**功能描述：**
- 管理员可以在登录后通过个人中心修改密码
- 无需邮件验证，直接通过旧密码验证后设置新密码
- 密码修改后需要重新登录

**实现内容：**

#### 后端实现：
1. **新增API端点：** `POST /api/auth/reset-password`
   - 文件：`backend/src/controllers/authController.js`
   - 文件：`backend/src/routes/api.js`
   
2. **功能特性：**
   - 需要提供旧密码和新密码
   - 验证旧密码是否正确
   - 新密码长度至少6位
   - 更新配置文件中的密码
   - 需要登录后才能访问（使用 `authMiddleware`）

#### 前端实现：
1. **新增个人中心页面：** `frontend/src/views/profile/index.vue`
   - 显示用户信息（角色、登录时间）
   - 提供"修改密码"功能
   - 实现密码修改表单验证
   
2. **更新路由配置：** `frontend/src/router/index.js`
   - 添加个人中心路由 `/profile`
   
3. **更新导航栏：** `frontend/src/layout/components/Navbar.vue`
   - 在用户下拉菜单中添加"个人中心"入口
   
4. **更新API接口：** `frontend/src/api/index.js`
   - 添加 `resetPassword` 方法

**使用步骤：**
1. 使用当前密码登录系统
2. 点击右上角用户名，在下拉菜单中选择"个人中心"
3. 在个人中心页面点击"修改密码"按钮
4. 在弹出的对话框中输入：
   - 旧密码
   - 新密码（至少6位）
   - 确认新密码
5. 点击"确定"按钮
6. 修改成功后，系统会提示是否立即退出登录
7. 使用新密码重新登录

**安全说明：**
- 必须先登录才能修改密码
- 必须提供正确的旧密码
- 新密码会立即生效
- 密码会持久化保存到配置文件
- 修改密码后建议立即重新登录

---

## 测试清单

### 统计数据显示测试
- [ ] 访问短链，确认访问被记录
- [ ] 在"链接管理"页面查看访问次数是否增加
- [ ] 在"统计分析"页面查看详细统计数据
- [ ] 在"仪表板"页面查看总体统计数据
- [ ] 验证各项数据（总访问量、今日访问、独立访客等）是否正确显示

### 密码修改功能测试
- [ ] 使用当前密码成功登录
- [ ] 点击右上角用户名，查看下拉菜单是否有"个人中心"选项
- [ ] 进入个人中心页面，查看用户信息是否正确显示
- [ ] 点击"修改密码"按钮，弹出修改密码对话框
- [ ] 输入错误的旧密码，验证是否提示错误
- [ ] 输入正确的旧密码和新密码（少于6位），验证是否提示错误
- [ ] 输入正确的旧密码和新密码（至少6位），确认密码不一致时提示错误
- [ ] 输入正确的旧密码和新密码（两次一致），确认修改成功
- [ ] 确认是否提示重新登录
- [ ] 使用新密码重新登录，验证是否成功
- [ ] 使用旧密码尝试登录，验证是否失败

---

## 注意事项

1. **密码修改功能：**
   - 密码会保存到 `backend/src/config/app.js` 文件
   - 如果使用环境变量 `ADMIN_PASSWORD`，需要同时更新环境变量
   - 建议定期更换密码以提高安全性
   - 修改密码后必须重新登录才能继续使用系统

2. **统计数据：**
   - 统计数据基于实际访问记录
   - 如果没有访问记录，统计数据会显示为0（这是正常现象）
   - 访问日志会持久化保存到数据库

3. **部署建议：**
   - 重启服务后，新密码会立即生效
   - 建议在生产环境使用环境变量管理密码
   - 定期备份数据库以防数据丢失

4. **个人中心：**
   - 个人中心页面不会在侧边栏显示
   - 只能通过右上角用户下拉菜单访问
   - 目前仅提供密码修改功能，后续可扩展更多功能

---

## 文件变更清单

### 修改的文件：
1. `frontend/src/views/stats/index.vue` - 修复统计数据字段映射
2. `frontend/src/views/dashboard/index.vue` - 修复仪表板数据字段映射
3. `backend/src/controllers/authController.js` - 添加密码重置控制器方法
4. `backend/src/routes/api.js` - 添加密码重置路由
5. `frontend/src/api/index.js` - 添加密码重置API接口
6. `frontend/src/router/index.js` - 添加个人中心路由
7. `frontend/src/layout/components/Navbar.vue` - 添加个人中心入口

### 新增的文件：
1. `frontend/src/views/profile/index.vue` - 个人中心页面
2. `docs/FEATURE_UPDATE.md` - 本文档